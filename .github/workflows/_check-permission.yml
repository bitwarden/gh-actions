name: Reusable Permission Check

on:
  workflow_call:
    inputs:
      failure_mode:
        description: 'Permission check failure mode: fail, skip, or continue'
        type: string
        default: 'fail'
        required: false
      require_permission:
        description: 'Required permission level: admin, write, read, or none'
        type: string
        default: 'write'
        required: false
    outputs:
      has_permission:
        description: "Whether the user has the required permission"
        value: ${{ jobs.check-permission.outputs.has_permission }}
      user_permission:
        description: "The actual permission level of the user"
        value: ${{ jobs.check-permission.outputs.user_permission }}
      should_skip:
        description: "Whether subsequent jobs should be skipped"
        value: ${{ jobs.check-permission.outputs.should_skip }}

permissions:
  contents: read

jobs:
  check-permission:
    name: Check Permission
    runs-on: ubuntu-22.04
    outputs:
      has_permission: ${{ steps.check.outputs.has_permission }}
      user_permission: ${{ steps.check.outputs.user_permission }}
      should_skip: ${{ steps.check.outputs.should_skip }}
    steps:
      - name: Check out repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Check user permission
        id: check
        uses: ./check-permission
        with:
          require: ${{ inputs.require_permission }}
          username: ${{ github.triggering_actor }}
          token: ${{ secrets.GITHUB_TOKEN }}
          failure_mode: ${{ inputs.failure_mode }}

      - name: Report results
        run: |
          echo "ðŸ¤– Permission Check"
          echo "================================"
          echo "User: ${{ github.triggering_actor }}"
          echo "Required: ${{ inputs.require_permission }}"
          echo "Actual: ${{ steps.check.outputs.user_permission }}"
          echo "Has permission: ${{ steps.check.outputs.has_permission }}"
          echo "Should skip: ${{ steps.check.outputs.should_skip }}"
