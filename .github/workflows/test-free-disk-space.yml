name: Test Free Disk Space Action

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'free-disk-space/**'
      - '.github/workflows/test-free-disk-space.yml'

permissions:
  contents: read

jobs:
  test-defaults:
    name: Test with defaults (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-22.04
          - ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Run action with defaults
        uses: ./free-disk-space

      - name: Verify cleanup worked
        run: |
          # Add header to summary
          echo "### Default Cleanup Test (${{ matrix.os }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "=== Verifying directories were removed ===" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Function to check if directory was removed
          check_removed() {
            if [ ! -d "$1" ]; then
              echo "✓ $2 removed successfully" | tee -a $GITHUB_STEP_SUMMARY
              return 0
            else
              echo "✗ $2 still exists at $1" | tee -a $GITHUB_STEP_SUMMARY
              return 1
            fi
          }

          FAILED=0

          check_removed "/usr/share/dotnet" "dotnet" || FAILED=1
          check_removed "/usr/local/lib/android" "android" || FAILED=1
          check_removed "/usr/share/miniconda" "miniconda" || FAILED=1
          check_removed "/usr/share/swift" "swift" || FAILED=1
          check_removed "/usr/local/.ghcup" "haskell" || FAILED=1

          if [ $FAILED -eq 1 ]; then
            echo "" | tee -a $GITHUB_STEP_SUMMARY
            echo "ERROR: Some directories were not removed as expected" | tee -a $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✓ All directories successfully removed" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  test-selective-removal:
    name: Test selective removal (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-22.04
          - ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Run action keeping dotnet and swift
        uses: ./free-disk-space
        with:
          remove-dotnet: false
          remove-swift: false

      - name: Verify selective cleanup
        run: |
          # Add header to summary
          echo "### Selective Removal Test (${{ matrix.os }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "=== Verifying selective cleanup ===" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FAILED=0

          # Check that dotnet and swift were KEPT
          if [ -d "/usr/share/dotnet" ]; then
            echo "✓ dotnet kept as requested" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "✗ dotnet was removed (should be kept)" | tee -a $GITHUB_STEP_SUMMARY
            FAILED=1
          fi

          if [ -d "/usr/share/swift" ]; then
            echo "✓ swift kept as requested" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "✗ swift was removed (should be kept)" | tee -a $GITHUB_STEP_SUMMARY
            FAILED=1
          fi

          # Check that others were REMOVED
          if [ ! -d "/usr/local/lib/android" ]; then
            echo "✓ android removed" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "✗ android still exists (should be removed)" | tee -a $GITHUB_STEP_SUMMARY
            FAILED=1
          fi

          if [ ! -d "/usr/share/miniconda" ]; then
            echo "✓ miniconda removed" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "✗ miniconda still exists (should be removed)" | tee -a $GITHUB_STEP_SUMMARY
            FAILED=1
          fi

          if [ ! -d "/usr/local/.ghcup" ]; then
            echo "✓ haskell removed" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "✗ haskell still exists (should be removed)" | tee -a $GITHUB_STEP_SUMMARY
            FAILED=1
          fi

          if [ $FAILED -eq 1 ]; then
            echo "" | tee -a $GITHUB_STEP_SUMMARY
            echo "ERROR: Selective removal did not work as expected" | tee -a $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✓ Selective removal worked correctly" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  test-cross-platform:
    name: Test ${{ matrix.os }} (should skip)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - macos-14
          - windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Run action (should skip cleanup)
        uses: ./free-disk-space

      - name: Verify action completed
        shell: bash
        run: |
          # Add header to summary
          echo "### Cross-Platform Test (${{ matrix.os }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "✓ Action completed successfully on ${{ matrix.os }}" | tee -a $GITHUB_STEP_SUMMARY
          echo "  (cleanup automatically skipped for non-Linux platforms)" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  test-summary:
    name: Test Summary
    runs-on: ubuntu-24.04
    needs:
      - test-defaults
      - test-selective-removal
      - test-cross-platform
    if: always()

    steps:
      - name: Check test results
        env:
          DEFAULTS_RESULT: ${{ needs.test-defaults.result }}
          SELECTIVE_RESULT: ${{ needs.test-selective-removal.result }}
          PLATFORM_RESULT: ${{ needs.test-cross-platform.result }}
        run: |
          # Add header to summary
          echo "## Overall Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY

          # Add each test result to summary
          if [ "$DEFAULTS_RESULT" = "success" ]; then
            echo "| Default Cleanup | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Default Cleanup | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$SELECTIVE_RESULT" = "success" ]; then
            echo "| Selective Removal | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Selective Removal | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$PLATFORM_RESULT" = "success" ]; then
            echo "| Cross-Platform | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Cross-Platform | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$DEFAULTS_RESULT" != "success" ] || \
             [ "$SELECTIVE_RESULT" != "success" ] || \
             [ "$PLATFORM_RESULT" != "success" ]; then
            echo "❌ Some tests failed" | tee -a $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "✅ All tests passed successfully!" | tee -a $GITHUB_STEP_SUMMARY
