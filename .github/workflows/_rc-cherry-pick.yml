name: Cherry pick to RC

on:
  workflow_call:
    inputs:
      cherry_pick_branch:
        required: true
        type: string
      source_pr:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      cherry_pick_branch:
        required: true
        type: string
      source_pr:
        required: true
        type: string

permissions: {}

jobs:
  cherry-pick:
    name: Cherry Pick Commit
    env: 
      SOURCE_PR: "${{ inputs.source_pr }}"
      CHERRY_PICK_BRANCH: "${{ inputs.cherry_pick_branch }}"
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout target branch
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          ref: ${{ env.CHERRY_PICK_BRANCH }}
          fetch-depth: 0
          persist-credentials: true

      - name: Configure git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Extract commits from PR
        id: extract-commits
        run: |
          pr_number="$SOURCE_PR"

          echo "Fetching commits from PR: [#$pr_number]"
          commits=$(gh pr view "$pr_number" --json commits --jq '.commits[].oid' | tr '\n' ' ')

          echo "Commits to cherry-pick: [$commits]"
          echo "commits=$commits" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create cherry-pick branch
        id: create-branch
        run: |
          branch_name="cherry-pick-PR$SOURCE_PR-to-$CHERRY_PICK_BRANCH"
          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
          git checkout -b "$branch_name"

      - name: Cherry pick commit(s)
        run: |
          COMMITS="${{ steps.extract-commits.outputs.commits }}"

          echo "Cherry-picking commits to branch ${{ CHERRY_PICK_BRANCH }}"
          for commit in $COMMITS; do
            echo -n "Cherry-picking commit: [$commit]. "
            if ! git cherry-pick "$commit"; then
              echo '✗'
              echo "ERROR: Cherry-pick failed for commit [$commit]"
              git cherry-pick --abort
              exit 1
            else
              echo '✓'
            fi
          done

          echo "✓ All cherry-picks successful!"

      - name: Push cherry-pick branch
        run: |
          git push origin ${{ steps.create-branch.outputs.branch_name }}

      - name: Create Pull Request
        run: |
          pr_url=$(gh pr view "$SOURCE_PR" --json url --jq '.url')

          gh pr create \
            --base ${{ inputs.cherry_pick_branch }} \
            --head ${{ steps.create-branch.outputs.branch_name }} \
            --title "Cherry-pick PR [#$SOURCE_PR] to [$CHERRY_PICK_BRANCH]" \
            --body "Automated cherry-pick of PR [#$SOURCE_PR]($pr_url)" \
            --draft
        env:
          GH_TOKEN: ${{ github.token }}
