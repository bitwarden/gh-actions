name: Test API Commit Action

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "api-commit/**"
      - ".github/workflows/test-api-commit.yml"

permissions:
  contents: read

jobs:
  test-api-commit:
    name: Test API Commit
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Create test branch
        id: setup
        env:
          GH_TOKEN: ${{ github.token }}
          REPOSITORY: ${{ github.repository }}
        run: |
          TEST_BRANCH="api-commit-test-$(date +%s)"
          echo "test_branch=$TEST_BRANCH" >> "$GITHUB_OUTPUT"

          # Branch the test branch off main
          SHA=$(gh api "repos/$REPOSITORY/git/ref/heads/main" --jq '.object.sha')
          gh api "repos/$REPOSITORY/git/refs" \
            --method POST \
            -f "ref=refs/heads/$TEST_BRANCH" \
            -f "sha=$SHA"

      - name: Create test files
        run: |
          echo "content $(date +%s)" > api-commit-test-file-1.txt
          echo "content $(date +%s)" > api-commit-test-file-2.txt

      - name: Run API Commit action
        id: api-commit
        uses: ./api-commit
        with:
          files: |
            api-commit-test-file-1.txt
            api-commit-test-file-2.txt
          message: "chore: test API commit"
          branch: ${{ steps.setup.outputs.test_branch }}
          token: ${{ github.token }}

      - name: Validate commit was created
        env:
          BRANCH: ${{ steps.setup.outputs.test_branch }}
          COMMIT_SHA: ${{ steps.api-commit.outputs.commit_sha }}
          GH_TOKEN: ${{ github.token }}
          REPOSITORY: ${{ github.repository }}
        run: |
          echo "Commit SHA from action: $COMMIT_SHA"

          if [[ -z "$COMMIT_SHA" ]]; then
            echo "::error::commit_sha output was empty"
            exit 1
          fi

          REMOTE_SHA=$(git ls-remote origin "refs/heads/$BRANCH" | cut -f1)
          echo "Remote branch HEAD SHA: $REMOTE_SHA"

          if [[ "$REMOTE_SHA" != "$COMMIT_SHA" ]]; then
            echo "::error::SHA mismatch: action returned $COMMIT_SHA but branch HEAD is $REMOTE_SHA"
            exit 1
          fi

          CHANGED_FILES=$(gh api "repos/$REPOSITORY/commits/$COMMIT_SHA" --jq '[.files[].filename] | sort | join(",")')
          echo "Files changed in commit: $CHANGED_FILES"

          if [[ "$CHANGED_FILES" != "api-commit-test-file-1.txt,api-commit-test-file-2.txt" ]]; then
            echo "::error::Expected both test files in commit, got: $CHANGED_FILES"
            exit 1
          fi

          echo "Commit verified successfully"

      - name: Check commit verification status
        env:
          GH_TOKEN: ${{ github.token }}
          COMMIT_SHA: ${{ steps.api-commit.outputs.commit_sha }}
          REPOSITORY: ${{ github.repository }}
        run: |
          # GitHub automatically signs commits created via the Git Data API,
          # so verified=true is expected regardless of which token is used.
          VERIFIED=$(gh api "repos/$REPOSITORY/commits/$COMMIT_SHA" --jq '.commit.verification.verified')
          REASON=$(gh api "repos/$REPOSITORY/commits/$COMMIT_SHA" --jq '.commit.verification.reason')
          echo "Verified: $VERIFIED (reason: $REASON)"

          if [[ "$VERIFIED" != "true" ]]; then
            echo "::error::Expected commit to be verified, got verified=$VERIFIED reason=$REASON"
            exit 1
          fi

      - name: Cleanup test branch
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH: ${{ steps.setup.outputs.test_branch }}
        run: |
          if [[ -n "$BRANCH" ]] && git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
            git push origin --delete "$BRANCH" || echo "WARN: Failed to delete test branch $BRANCH"
          fi

  # test-api-commit-auto-detect:
  #   name: Test API Commit Auto-detect
  #   runs-on: ubuntu-24.04
  #   permissions:
  #     contents: write
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
  #       with:
  #         ref: main
  #         fetch-depth: 0
  #         persist-credentials: true

  #     - name: Configure git
  #       run: |
  #         git config user.name "GitHub Actions Bot"
  #         git config user.email "actions@github.com"

  #     - name: Create test branch with initial file
  #       id: setup
  #       env:
  #         GH_TOKEN: ${{ github.token }}
  #       run: |
  #         TEST_BRANCH="api-commit-auto-test-$(date +%s)"
  #         echo "test_branch=$TEST_BRANCH" >> "$GITHUB_OUTPUT"

  #         git switch -c "$TEST_BRANCH"
  #         echo "initial content" > api-commit-auto-test-file.txt
  #         git add api-commit-auto-test-file.txt
  #         git commit -m "Add initial test file"
  #         git push origin "$TEST_BRANCH"

  #     - name: Modify test file
  #       run: echo "updated content $(date +%s)" > api-commit-auto-test-file.txt

  #     - name: Run API Commit action without files input
  #       id: api-commit
  #       uses: ./api-commit
  #       with:
  #         message: "chore: test API commit auto-detect"
  #         branch: ${{ steps.setup.outputs.test_branch }}
  #         token: ${{ github.token }}

  #     - name: Validate commit was created
  #       env:
  #         BRANCH: ${{ steps.setup.outputs.test_branch }}
  #         COMMIT_SHA: ${{ steps.api-commit.outputs.commit_sha }}
  #       run: |
  #         echo "Commit SHA from action: $COMMIT_SHA"

  #         if [[ -z "$COMMIT_SHA" ]]; then
  #           echo "::error::commit_sha output was empty"
  #           exit 1
  #         fi

  #         REMOTE_SHA=$(git ls-remote origin "refs/heads/$BRANCH" | cut -f1)
  #         echo "Remote branch HEAD SHA: $REMOTE_SHA"

  #         if [[ "$REMOTE_SHA" != "$COMMIT_SHA" ]]; then
  #           echo "::error::SHA mismatch: action returned $COMMIT_SHA but branch HEAD is $REMOTE_SHA"
  #           exit 1
  #         fi

  #         echo "Commit verified successfully"

  #     - name: Check commit verification status
  #       env:
  #         GH_TOKEN: ${{ github.token }}
  #         COMMIT_SHA: ${{ steps.api-commit.outputs.commit_sha }}
  #         REPOSITORY: ${{ github.repository }}
  #       run: |
  #         # Note: commits created with GITHUB_TOKEN will show verified=false/unsigned.
  #         # When a GitHub App token is used instead, verified=true/valid is expected.
  #         gh api "repos/$REPOSITORY/commits/$COMMIT_SHA" \
  #           --jq '"Verified: \(.commit.verification.verified) (reason: \(.commit.verification.reason))"'

  #     - name: Cleanup test branch
  #       if: always()
  #       env:
  #         GH_TOKEN: ${{ github.token }}
  #         BRANCH: ${{ steps.setup.outputs.test_branch }}
  #       run: |
  #         if [[ -n "$BRANCH" ]] && git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
  #           git push origin --delete "$BRANCH" || echo "WARN: Failed to delete test branch $BRANCH"
  #         fi
