name: Code Review

on:
  workflow_call:
    secrets:
      AZURE_SUBSCRIPTION_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_CLIENT_ID:
        required: true

concurrency:
  group: ${{ github.repository }}-${{ github.workflow }}-${{ github.event.pull_request.number || github.head_ref || github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  check-permission:
    name: Check permission
    uses: ./.github/workflows/_check-permission.yml
    with:
      failure_mode: "skip"
      require_permission: "write"
    permissions:
      contents: read

  validation:
    name: Validation
    needs: check-permission
    if: needs.check-permission.outputs.should_proceed == 'true'
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      pull-requests: read
    outputs:
      should_review: ${{ steps.validate.outputs.should_review }}
      review_variant: ${{ steps.validate.outputs.review_variant }}

    steps:
      - name: Check for review label
        id: check-label
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          if [ -z "${PR_NUMBER:-}" ]; then
            echo "label_found=none" >> "$GITHUB_OUTPUT"
            echo "review_variant=none" >> "$GITHUB_OUTPUT"
            echo "⚠️ Validation: no pull_request context detected - skipping Claude review"
            exit 0
          fi

          LABELS=$(gh pr view "$PR_NUMBER" --repo "$GH_REPO" --json labels -q '.labels[].name')

          if printf '%s\n' "$LABELS" | grep -Fxq "ai-review-vnext"; then
            echo "label_found=ai-review-vnext" >> "$GITHUB_OUTPUT"
            echo "review_variant=vnext" >> "$GITHUB_OUTPUT"
            echo "✅ Validation: 'ai-review-vnext' label found"

          elif printf '%s\n' "$LABELS" | grep -Fxq "ai-review"; then
            echo "label_found=ai-review" >> "$GITHUB_OUTPUT"
            echo "review_variant=current" >> "$GITHUB_OUTPUT"
            echo "✅ Validation: 'ai-review' label found"

          else
            echo "label_found=none" >> "$GITHUB_OUTPUT"
            echo "review_variant=none" >> "$GITHUB_OUTPUT"
            echo "⚠️ Validation: no review label found - skipping Claude review"
          fi

      - name: Set validation result
        id: validate
        env:
          REVIEW_VARIANT: ${{ steps.check-label.outputs.review_variant }}
        run: |
          if [ "$REVIEW_VARIANT" != "none" ]; then
            echo "should_review=true" >> "$GITHUB_OUTPUT"
            echo "review_variant=$REVIEW_VARIANT" >> "$GITHUB_OUTPUT"
            echo "✅ Validation passed - code review will proceed (variant: $REVIEW_VARIANT)"

          else
            echo "should_review=false" >> "$GITHUB_OUTPUT"
            echo "review_variant=none" >> "$GITHUB_OUTPUT"
            echo "⚠️ Validation failed - code review will be skipped"
          fi

  review:
    name: Review
    runs-on: ubuntu-24.04
    needs: [check-permission, validation]
    if: needs.check-permission.outputs.should_proceed == 'true' && needs.validation.outputs.should_review == 'true'
    timeout-minutes: 15
    permissions:
      actions: read
      contents: read
      id-token: write
      pull-requests: write

    steps:
      - name: Run current review
        if: needs.validation.outputs.review_variant == 'current'
        uses: bitwarden/gh-actions/review-code@main
        with:
          azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          azure_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          azure_client_id: ${{ secrets.AZURE_CLIENT_ID }}
          pr_number: ${{ github.event.pull_request.number }}
          repository: ${{ github.repository }}
          checkout_ref: ${{ github.event.pull_request.head.sha }}
          github_token: ${{ github.token }}

      - name: Run vNext review
        if: needs.validation.outputs.review_variant == 'vnext'
        uses: bitwarden/gh-actions/review-code-vnext@main
        with:
          azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          azure_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          azure_client_id: ${{ secrets.AZURE_CLIENT_ID }}
          pr_number: ${{ github.event.pull_request.number }}
          repository: ${{ github.repository }}
          checkout_ref: ${{ github.event.pull_request.head.sha }}
          github_token: ${{ github.token }}
