name: Respond

on:
  workflow_call:
    secrets:
      AZURE_SUBSCRIPTION_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_CLIENT_ID:
        required: true

permissions: {}

jobs:
  validation:
    name: Validation
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      should_comment: ${{ steps.validate.outputs.should_comment }}
    steps:
      - name: Check triggering actor
        id: check-actor
        env:
          ACTOR: ${{ github.actor }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          REVIEW_AUTHOR: ${{ github.event.review.user.login }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
        run: |
          # Get the actual author of the comment/review/issue
          AUTHOR="${COMMENT_AUTHOR:-${REVIEW_AUTHOR:-${ISSUE_AUTHOR}}}"

          # List of bots that should not trigger Claude responses
          BLOCKED_BOTS=("claude[bot]" "copilot[bot]" "github-actions[bot]" "dependabot[bot]" "codecov[bot]" "sonarqubecloud[bot]" "renovate[bot]")

          IS_BOT=false
          for BOT in "${BLOCKED_BOTS[@]}"; do
            if [ "$ACTOR" == "$BOT" ] || [ "$AUTHOR" == "$BOT" ]; then
              IS_BOT=true
              echo "⏭️  Blocked bot detected: $BOT - skipping workflow"
              break
            fi
          done

          if [ "$IS_BOT" == "true" ]; then
            echo "is_bot=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_bot=false" >> "$GITHUB_OUTPUT"
            echo "✅ Human user detected: $AUTHOR"
          fi

      - name: Check GitHub event
        id: check-github-event
        env:
          EVENT_NAME: ${{ github.event_name }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          REVIEW_BODY: ${{ github.event.review.body }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Check if @claude is mentioned in the event
          MENTIONED=false

          if [ "$EVENT_NAME" == "issue_comment" ] && echo "$COMMENT_BODY" | grep -qF "@claude"; then
            MENTIONED=true
          elif [ "$EVENT_NAME" == "pull_request_review_comment" ] && echo "$COMMENT_BODY" | grep -qF "@claude"; then
            MENTIONED=true
          elif [ "$EVENT_NAME" == "pull_request_review" ] && echo "$REVIEW_BODY" | grep -qF "@claude"; then
            MENTIONED=true
          elif [ "$EVENT_NAME" == "issues" ] && echo "$ISSUE_BODY" | grep -qF "@claude"; then
            MENTIONED=true
          fi

          if [ "$MENTIONED" == "true" ]; then
            echo "claude_mentioned=true" >> "$GITHUB_OUTPUT"
            echo "✅ Validation: @claude mentioned in event"
          else
            echo "claude_mentioned=false" >> "$GITHUB_OUTPUT"
            echo "⏭️  Validation: @claude not mentioned - skipping"
          fi

      - name: Set validation result
        id: validate
        env:
          CLAUDE_MENTIONED: ${{ steps.check-github-event.outputs.claude_mentioned }}
          IS_BOT: ${{ steps.check-actor.outputs.is_bot }}
        run: |
          if [ "$IS_BOT" == "true" ]; then
            echo "should_comment=false" >> "$GITHUB_OUTPUT"
            echo "⚠️  Bot-triggered - workflow will be skipped"
          elif [ "$CLAUDE_MENTIONED" == "true" ]; then
            echo "should_comment=true" >> "$GITHUB_OUTPUT"
            echo "✅ Validation passed - workflow will proceed"
          else
            echo "should_comment=false" >> "$GITHUB_OUTPUT"
            echo "⚠️  @claude not mentioned - workflow will be skipped"
          fi

  check-run:
    name: Check PR run
    needs: validation
    if: needs.validation.outputs.should_comment == 'true'
    uses: ./.github/workflows/check-run.yml
    permissions:
      contents: read

  comment:
    name: Claude comment
    runs-on: ubuntu-24.04
    needs: [validation, check-run]
    timeout-minutes: 15
    if: needs.validation.outputs.should_comment == 'true'
    permissions:
      actions: read
      contents: write
      id-token: write
      issues: write
      pull-requests: write

    steps:
      - name: Check out repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 1
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: true

      - name: Log in to Azure
        uses: bitwarden/gh-actions/azure-login@main
        with:
          subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          client_id: ${{ secrets.AZURE_CLIENT_ID }}

      - name: Get Azure Key Vault secrets
        id: get-kv-secrets
        uses: bitwarden/gh-actions/get-keyvault-secrets@main
        with:
          keyvault: gh-org-bitwarden
          secrets: "ANTHROPIC-RESPONSE-API-KEY"

      - name: Log out from Azure
        uses: bitwarden/gh-actions/azure-logout@main

      - name: Run Claude Code
        id: claude
        timeout-minutes: 10
        uses: anthropics/claude-code-action@f30f5eecfce2f34fa72e40fa5f7bcdbdcad12eb8 # v1.0.14
        with:
          anthropic_api_key: ${{ steps.get-kv-secrets.outputs.ANTHROPIC-RESPONSE-API-KEY }}
          track_progress: true
          use_sticky_comment: true
          prompt: ${{ github.event.comment.body || github.event.review.body || github.event.issue.body }}
          claude_args: |
            --allowedTools "mcp__github_comment__update_claude_comment,mcp__github_inline_comment__create_inline_comment,Bash(gh pr diff:*),Bash(gh pr view:*)"
