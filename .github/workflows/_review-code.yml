name: Code Review

on:
  workflow_call:
    secrets:
      AZURE_SUBSCRIPTION_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_CLIENT_ID:
        required: true

concurrency:
  group: ${{ github.repository }}-${{ github.workflow }}-${{ github.event.pull_request.number || github.head_ref || github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  validation:
    name: Validation
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      should_review: ${{ steps.validate.outputs.should_review }}

    steps:
      - name: Check PR is not a draft
        id: check-pr
        env:
          IS_DRAFT: ${{ github.event.pull_request.draft }}
        run: |
          if [ "$IS_DRAFT" == "true" ]; then
            echo "âš ï¸  Validation: PR is a draft - skipping review"
            echo "pr_valid=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Validation: PR is ready for review"
            echo "pr_valid=true" >> $GITHUB_OUTPUT
          fi

      - name: Check if PR is from a bot
        id: check-user-type-bot
        env:
          PR_AUTHOR_TYPE: ${{ github.event.pull_request.user.type }}
        run: |
          if [ "$PR_AUTHOR_TYPE" == "Bot" ]; then
            echo "âš ï¸  Validation: PR opened by bot - skipping review"
            echo "is_bot=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Validation: PR opened by human user"
            echo "is_bot=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if prompt file exists using GitHub CLI
        id: check-prompt
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          REF: ${{ github.event.pull_request.head.sha }}
          FILE_PATH: ".claude/prompts/review-code.md"
        run: |
          if gh api "repos/$REPO/contents/$FILE_PATH?ref=$REF" --silent 2>/dev/null; then
            echo "prompt_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Found $FILE_PATH in $REPO"
          else
            echo "prompt_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Validation: No $FILE_PATH found - skipping Claude review"
          fi

      - name: Set validation result
        id: validate
        env:
          PR_VALID: ${{ steps.check-pr.outputs.pr_valid }}
          PROMPT_EXISTS: ${{ steps.check-prompt.outputs.prompt_exists }}
          IS_BOT: ${{ steps.check-user-type-bot.outputs.is_bot }}
        run: |
          if [ "$PR_VALID" == "true" ] && \
             [ "$PROMPT_EXISTS" == "true" ] && \
             [ "$IS_BOT" == "false" ]; then
            echo "should_review=true" >> $GITHUB_OUTPUT
            echo "âœ… Validation passed - code review will proceed"
          else
            echo "should_review=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Validation failed - code review will be skipped"
          fi

  review:
    name: Review
    runs-on: ubuntu-24.04
    needs: validation
    if: needs.validation.outputs.should_review == 'true'
    permissions:
      contents: read
      id-token: write
      pull-requests: write

    steps:
      - name: Check out repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: false

      - name: Log in to Azure
        uses: bitwarden/gh-actions/azure-login@main
        with:
          subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          client_id: ${{ secrets.AZURE_CLIENT_ID }}

      - name: Get Azure Key Vault secrets
        id: get-kv-secrets
        uses: bitwarden/gh-actions/get-keyvault-secrets@main
        with:
          keyvault: gh-org-bitwarden
          secrets: "ANTHROPIC-CODE-REVIEW-API-KEY"

      - name: Log out from Azure
        uses: bitwarden/gh-actions/azure-logout@main

      - name: Build review prompt
        id: build-prompt
        env:
          GH_TOKEN: ${{ github.token }}
          PR_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_COMMIT: ${{ github.event.pull_request.head.sha }}
          PROMPT_FILE: ".claude/prompts/review-code.md"
          REUSABLE_PROMPT_REPO: "bitwarden/gh-actions"
          REUSABLE_PROMPT_FILE: ".claude/prompts/bitwarden-review-code.md"
          REUSABLE_PROMPT_TEMP_FILE: "/tmp/bitwarden-review-code-prompt.md"
        run: |
          set -e
          echo "ðŸ“¥ Fetching Bitwarden prompt file..."

          # Fetch the prompt file from gh-actions repo using GitHub API
          gh api "repos/$REUSABLE_PROMPT_REPO/contents/$REUSABLE_PROMPT_FILE" \
            --jq '.content' | base64 -d > "$REUSABLE_PROMPT_TEMP_FILE" || true

          if [ -f "$REUSABLE_PROMPT_TEMP_FILE" ] && [ -s "$REUSABLE_PROMPT_TEMP_FILE" ]; then
            echo "âœ… Successfully fetched Bitwarden prompt file"
            echo "ðŸ“„ File size: $(wc -c < "$REUSABLE_PROMPT_TEMP_FILE") bytes"
          else
            echo "âš ï¸  Warning: Failed to fetch Bitwarden prompt file - continuing without it"
            touch "$REUSABLE_PROMPT_TEMP_FILE"
          fi

          # Build the code review prompt
          {
            cat "$REUSABLE_PROMPT_TEMP_FILE"
            printf "\n\n---\n\n"
            printf "REPO: %s\n" "$PR_REPO"
            printf "PR NUMBER: %s\n" "$PR_NUMBER"
            printf "TITLE: %s\n" "$PR_TITLE"
            printf "BODY: %s\n" "$PR_BODY"
            printf "AUTHOR: %s\n" "$PR_AUTHOR"
            printf "COMMIT: %s\n" "$PR_COMMIT"
            printf "\n"
            printf "Note: The PR branch is already checked out in the current working directory.\n"
            printf "\n---\n\n"
            cat "$PROMPT_FILE"
          } > /tmp/review-prompt.md

          # Output the prompt
          {
            echo 'FINAL_PROMPT<<EOF'
            cat /tmp/review-prompt.md
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Review with Claude Code
        uses: anthropics/claude-code-action@8a1c4371755898f67cd97006ba7c97702d5fc4bf # v1.0.16
        with:
          anthropic_api_key: ${{ steps.get-kv-secrets.outputs.ANTHROPIC-CODE-REVIEW-API-KEY }}
          track_progress: true
          use_sticky_comment: true
          prompt: ${{ steps.build-prompt.outputs.FINAL_PROMPT }}
          claude_args: |
            --allowedTools "mcp__github_comment__update_claude_comment,mcp__github_inline_comment__create_inline_comment,Bash(gh pr diff:*),Bash(gh pr view:*)"
