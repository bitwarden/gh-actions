name: Permission Check

on:
  workflow_call:
    inputs:
      failure_mode:
        description: "Permission check failure mode: fail, skip, or continue"
        type: string
        default: "fail"
        required: false
      require_permission:
        description: "Required permission level: admin, write, read, or none"
        type: string
        default: "write"
        required: false
    outputs:
      has_permission:
        description: "Whether the user has the required permission"
        value: ${{ jobs.check-permission.outputs.has_permission }}
      user_permission:
        description: "The actual permission level of the user"
        value: ${{ jobs.check-permission.outputs.user_permission }}
      should_proceed:
        description: "Whether subsequent jobs should proceed"
        value: ${{ jobs.check-permission.outputs.should_proceed }}

permissions:
  contents: read

jobs:
  check-permission:
    name: Check permission
    runs-on: ubuntu-24.04
    outputs:
      has_permission: ${{ steps.check.outputs.has_permission }}
      user_permission: ${{ steps.check.outputs.user_permission }}
      should_proceed: ${{ steps.check.outputs.should_proceed }}
    steps:
      - name: Check out repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Check user permission
        id: check
        uses: bitwarden/gh-actions/check-permission@main
        with:
          require: ${{ inputs.require_permission }}
          username: ${{ github.triggering_actor }}
          token: ${{ secrets.GITHUB_TOKEN }}
          failure_mode: ${{ inputs.failure_mode }}

      - name: Report results
        env:
          ACTOR: ${{ github.triggering_actor }}
          REQUIRED: ${{ inputs.require_permission }}
          ACTUAL: ${{ steps.check.outputs.user_permission }}
          HAS_PERM: ${{ steps.check.outputs.has_permission }}
          SHOULD_PROCEED: ${{ steps.check.outputs.should_proceed }}
        run: |
          echo "ðŸ¤– Permission Check"
          echo "================================"
          echo "User: $ACTOR"
          echo "Required: $REQUIRED"
          echo "Actual: $ACTUAL"
          echo "Has permission: $HAS_PERM"
          echo "Should proceed: $SHOULD_PROCEED"
