name: Test Version Check Action

on:
  pull_request:
    paths:
      - "release-check-version"
  push:
    branches:
      - "main"
  workflow_dispatch:
    inputs: {}

permissions:
  contents: read

jobs:
  test-version-check:
    name: Test Version Check
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ts_semver_success
            project-type: ts
            file: release-version-check/tests/fixtures/SemVer/package.json
            override-version: 1.1.0
          - name: ts_semver_fail
            project-type: ts
            file: release-version-check/tests/fixtures/SemVer/package.json
            override-version: 1.0.1
          - name: ts_calver_success
            project-type: ts
            file: release-version-check/tests/fixtures/CalVer/package.json
            override-version: 2022.06.0
          - name: ts_calver_fail
            project-type: ts
            file: release-version-check/tests/fixtures/CalVer/package.json
            override-version: 2022.05.0
          - name: dotnet_calver_success
            project-type: dotnet
            file: release-version-check/tests/fixtures/CalVer/Test.csproj
            override-version: 2022.06.0
          - name: dotnet_calver_fail
            project-type: dotnet
            file: release-version-check/tests/fixtures/CalVer/Test.csproj
            override-version: 2022.05.0
          - name: xamarin_calver_success
            project-type: xamarin
            file: release-version-check/tests/fixtures/CalVer/Mobile-Android.xml
            override-version: 2022.05.1
          - name: xamarin_calver_fail
            project-type: xamarin
            file: release-version-check/tests/fixtures/CalVer/Mobile-Android.xml
            override-version: 2022.05.0
    outputs:
      ts_semver_success_status: ${{ steps.set-status.outputs.ts_semver_success }}
      ts_semver_fail_status: ${{ steps.set-status.outputs.ts_semver_fail }}
      ts_calver_success_status: ${{ steps.set-status.outputs.ts_calver_success }}
      ts_calver_fail_status: ${{ steps.set-status.outputs.ts_calver_fail }}
      dotnet_calver_success_status: ${{ steps.set-status.outputs.dotnet_calver_success }}
      dotnet_calver_fail_status: ${{ steps.set-status.outputs.dotnet_calver_fail }}
      xamarin_calver_success_status: ${{ steps.set-status.outputs.xamarin_calver_success }}
      xamarin_calver_fail_status: ${{ steps.set-status.outputs.xamarin_calver_fail }}
    steps:
      - name: Checkout Branch
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Version Check - ${{ matrix.name }}
        id: run-version-check
        continue-on-error: true
        uses: ./release-version-check
        with:
          release-type: Initial Release
          project-type: ${{ matrix.project-type }}
          file: ${{ matrix.file }}
          override-version: ${{ matrix.override-version }}

      - name: Set Status
        id: set-status
        env:
          MATRIX_NAME: ${{ matrix.name }}
          VERSION_CHECK_STATUS: ${{ steps.run-version-check.outputs.status }}
        run: |
          echo "Status Status - $MATRIX_NAME: $VERSION_CHECK_STATUS"
          echo "$MATRIX_NAME=$VERSION_CHECK_STATUS" >> "$GITHUB_OUTPUT"

  run-version-check-test:
    name: Run Version Check Test
    runs-on: ubuntu-22.04
    needs: [test-version-check]
    if: always()
    env:
      _TS_SEMVER_SUCCESS_STATUS: ${{ needs.test-version-check.outputs.ts_semver_success_status }}
      _TS_SEMVER_FAIL_STATUS: ${{ needs.test-version-check.outputs.ts_semver_fail_status }}
      _TS_CALVER_SUCCESS_STATUS: ${{ needs.test-version-check.outputs.ts_calver_success_status }}
      _TS_CALVER_FAIL_STATUS: ${{ needs.test-version-check.outputs.ts_calver_fail_status }}
      _DOTNET_CALVER_SUCCESS_STATUS: ${{ needs.test-version-check.outputs.dotnet_calver_success_status }}
      _DOTNET_CALVER_FAIL_STATUS: ${{ needs.test-version-check.outputs.dotnet_calver_fail_status }}
      _XAMARIN_CALVER_SUCCESS_STATUS: ${{ needs.test-version-check.outputs.xamarin_calver_success_status }}
      _XAMARIN_CALVER_FAIL_STATUS: ${{ needs.test-version-check.outputs.xamarin_calver_fail_status }}
    steps:
      - name: Validate Outputs
        run: |
          test_outputs=()

          function assert() {
            value="$1"
            expected_value="$2"
            test_name="$3"

            if [[ "$value" == "$expected_value" ]]; then
              echo "${test_name}: pass"
              test_outputs+=("pass")
            else
              echo "${test_name}: fail"
              test_outputs+=("fail")
            fi
          }

          assert "$_TS_SEMVER_SUCCESS_STATUS" "success" "Test TS SemVer Success"
          assert "$_TS_SEMVER_FAIL_STATUS" "fail" "Test TS SemVer Fail"
          assert "$_TS_CALVER_SUCCESS_STATUS" "success" "Test TS CalVer Success"
          assert "$_TS_CALVER_FAIL_STATUS" "fail" "Test TS CalVer Fail"
          assert "$_DOTNET_CALVER_SUCCESS_STATUS" "success" "Test .NET CalVer Success"
          assert "$_DOTNET_CALVER_FAIL_STATUS" "fail" "Test .NET CalVer Fail"
          assert "$_XAMARIN_CALVER_SUCCESS_STATUS" "success" "Test Xamarin CalVer Success"
          assert "$_XAMARIN_CALVER_FAIL_STATUS" "fail" "Test Xamarin CalVer Fail"

          joined_outputs="${test_outputs[*]}"
          if [[ $joined_outputs =~ fail ]]; then
            exit 1
          else
            exit 0
          fi
